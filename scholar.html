<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Source Research Agent (Key-less)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A slightly lighter gray */
        }
        /* Simple loading spinner animation */
        .loader {
            border: 4px solid #e5e7eb; /* Lighter gray for the track */
            border-top: 4px solid #3b82f6; /* Blue for the spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Multi-Source Research Agent</h1>
            <p class="text-md text-gray-600 mt-2">Search four open academic databases without needing an API key.</p>
        </header>

        <!-- Search Input -->
        <div class="mb-10 max-w-2xl mx-auto">
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="searchInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Enter your research topic..." value="project-based learning for EFL students">
                <button id="searchButton" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform transform hover:scale-105">
                    Search
                </button>
            </div>
        </div>

        <!-- Results Area -->
        <main id="resultsArea" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- API 1: arXiv -->
            <section id="arxiv-section">
                <h2 class="text-2xl font-semibold mb-4 pb-2 border-b-2 border-blue-200">
                    <a href="https://arxiv.org/" target="_blank" class="hover:underline">arXiv</a> Results
                </h2>
                <div id="arxiv-results" class="space-y-4"></div>
            </section>

            <!-- API 2: Crossref -->
            <section id="crossref-section">
                <h2 class="text-2xl font-semibold mb-4 pb-2 border-b-2 border-green-200">
                    <a href="https://www.crossref.org/" target="_blank" class="hover:underline">Crossref</a> Results
                </h2>
                <div id="crossref-results" class="space-y-4"></div>
            </section>

            <!-- API 3: Europe PMC -->
            <section id="europepmc-section">
                <h2 class="text-2xl font-semibold mb-4 pb-2 border-b-2 border-red-200">
                    <a href="https://europepmc.org/" target="_blank" class="hover:underline">Europe PMC</a> Results
                </h2>
                <div id="europepmc-results" class="space-y-4"></div>
            </section>

            <!-- API 4: OpenAlex -->
            <section id="openalex-section">
                <h2 class="text-2xl font-semibold mb-4 pb-2 border-b-2 border-purple-200">
                    <a href="https://openalex.org/" target="_blank" class="hover:underline">OpenAlex</a> Results
                </h2>
                <div id="openalex-results" class="space-y-4"></div>
            </section>
        </main>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const searchButton = document.getElementById('searchButton');
        const searchInput = document.getElementById('searchInput');
        const arxivResultsContainer = document.getElementById('arxiv-results');
        const crossrefResultsContainer = document.getElementById('crossref-results');
        const europepmcResultsContainer = document.getElementById('europepmc-results');
        const openalexResultsContainer = document.getElementById('openalex-results');

        // --- UTILITY FUNCTIONS ---
        
        function createLoader() {
            const loaderContainer = document.createElement('div');
            loaderContainer.className = 'flex justify-center items-center py-10';
            const loader = document.createElement('div');
            loader.className = 'loader';
            loaderContainer.appendChild(loader);
            return loaderContainer;
        }

        function createResultCard({ title, authors, abstract, url }) {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow h-full flex flex-col';
            
            const sanitizedTitle = title ? title.replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'No Title Available';
            const sanitizedAuthors = authors ? authors.replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'Not Available';
            const sanitizedAbstract = abstract ? abstract.replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'No abstract available.';

            card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="font-semibold text-lg text-blue-800 mb-2">
                        <a href="${url}" target="_blank" class="hover:underline">${sanitizedTitle}</a>
                    </h3>
                    <p class="text-sm text-gray-600 mb-3"><strong>Authors:</strong> ${sanitizedAuthors}</p>
                    <p class="text-gray-700 text-sm leading-relaxed">${sanitizedAbstract}</p>
                </div>
            `;
            return card;
        }

        function deinvertAbstract(invertedIndex) {
            if (!invertedIndex) return null;
            const termMap = new Map();
            for (const term in invertedIndex) {
                invertedIndex[term].forEach(pos => {
                    termMap.set(pos, term);
                });
            }
            const sortedPositions = Array.from(termMap.keys()).sort((a, b) => a - b);
            return sortedPositions.map(pos => termMap.get(pos)).join(' ');
        }

        // --- API FETCHING FUNCTIONS ---

        async function fetchArxiv(query) {
            arxivResultsContainer.innerHTML = '';
            arxivResultsContainer.appendChild(createLoader());
            const url = `https://export.arxiv.org/api/query?search_query=all:${encodeURIComponent(query)}&max_results=3`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                arxivResultsContainer.innerHTML = '';
                const entries = xmlDoc.querySelectorAll("entry");
                if (entries.length > 0) {
                    entries.forEach(entry => {
                        const link = entry.querySelector('link[rel="alternate"]') || entry.querySelector('link');
                        const card = createResultCard({
                            title: entry.querySelector("title").textContent.trim(),
                            authors: Array.from(entry.querySelectorAll("author > name")).map(name => name.textContent).join(', '),
                            abstract: entry.querySelector("summary").textContent.trim(),
                            url: link ? link.getAttribute('href') : entry.querySelector('id').textContent
                        });
                        arxivResultsContainer.appendChild(card);
                    });
                } else {
                    arxivResultsContainer.innerHTML = '<p class="text-gray-500">No results found on arXiv.</p>';
                }
            } catch (error) {
                console.error("arXiv Fetch Error:", error);
                arxivResultsContainer.innerHTML = `<p class="text-red-500">Failed to fetch results from arXiv.</p>`;
            }
        }

        async function fetchCrossref(query) {
            crossrefResultsContainer.innerHTML = '';
            crossrefResultsContainer.appendChild(createLoader());
            const url = `https://api.crossref.org/works?query=${encodeURIComponent(query)}&rows=3&mailto=guest@example.com`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                crossrefResultsContainer.innerHTML = '';
                if (data.message.items && data.message.items.length > 0) {
                    data.message.items.forEach(paper => {
                        const card = createResultCard({
                            title: paper.title ? paper.title[0] : 'No Title Available',
                            authors: paper.author ? paper.author.map(a => `${a.given || ''} ${a.family || ''}`.trim()).join(', ') : 'Not Available',
                            abstract: paper.abstract ? paper.abstract.replace(/<\/?jats:[^>]*>/g, '') : 'No abstract available.',
                            url: paper.URL
                        });
                        crossrefResultsContainer.appendChild(card);
                    });
                } else {
                    crossrefResultsContainer.innerHTML = '<p class="text-gray-500">No results found on Crossref.</p>';
                }
            } catch (error) {
                console.error("Crossref Fetch Error:", error);
                crossrefResultsContainer.innerHTML = `<p class="text-red-500">Failed to fetch results from Crossref.</p>`;
            }
        }
        
        async function fetchEuropePMC(query) {
            europepmcResultsContainer.innerHTML = '';
            europepmcResultsContainer.appendChild(createLoader());
            const url = `https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(query)}&format=json&resultType=core&pageSize=3`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                europepmcResultsContainer.innerHTML = '';
                if (data.resultList.result && data.resultList.result.length > 0) {
                    data.resultList.result.forEach(paper => {
                        const card = createResultCard({
                            title: paper.title,
                            authors: paper.authorString,
                            abstract: paper.abstractText,
                            url: `https://europepmc.org/article/PMC/${paper.pmcid}`
                        });
                        europepmcResultsContainer.appendChild(card);
                    });
                } else {
                    europepmcResultsContainer.innerHTML = '<p class="text-gray-500">No results found on Europe PMC.</p>';
                }
            } catch (error) {
                console.error("Europe PMC Fetch Error:", error);
                europepmcResultsContainer.innerHTML = `<p class="text-red-500">Failed to fetch results from Europe PMC.</p>`;
            }
        }

        async function fetchOpenAlex(query) {
            openalexResultsContainer.innerHTML = '';
            openalexResultsContainer.appendChild(createLoader());
            const url = `https://api.openalex.org/works?search=${encodeURIComponent(query)}&per-page=3`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                openalexResultsContainer.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    data.results.forEach(paper => {
                        const card = createResultCard({
                            title: paper.display_name,
                            authors: paper.authorships.map(a => a.author.display_name).join(', '),
                            abstract: deinvertAbstract(paper.abstract_inverted_index),
                            url: paper.doi ? `https://doi.org/${paper.doi.split('/').slice(3).join('/')}` : (paper.locations[0]?.landing_page_url || '#')
                        });
                        openalexResultsContainer.appendChild(card);
                    });
                } else {
                    openalexResultsContainer.innerHTML = '<p class="text-gray-500">No results found on OpenAlex.</p>';
                }
            } catch (error) {
                console.error("OpenAlex Fetch Error:", error);
                openalexResultsContainer.innerHTML = `<p class="text-red-500">Failed to fetch results from OpenAlex.</p>`;
            }
        }

        // --- EVENT HANDLERS ---
        
        function handleSearch() {
            const query = searchInput.value.trim();
            if (query) {
                fetchArxiv(query);
                fetchCrossref(query);
                fetchEuropePMC(query);
                fetchOpenAlex(query);
            } else {
                alert("Please enter a search topic.");
            }
        }

        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        // Perform a default search on page load
        document.addEventListener('DOMContentLoaded', handleSearch);

    </script>
</body>
</html>
