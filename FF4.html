<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESL Conversation Practice</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; touch-action: manipulation; overflow: hidden; background-color: #f1f5f9; }
.screen { display: none; height: 100vh; width: 100vw; }
.screen.active { display: flex; flex-direction: column; }
/* Menu Buttons */
.unit-btn { transition: all 0.2s ease; border: 3px solid transparent; background-color: white; }
.unit-btn:hover { transform: translateY(-3px); border-color: #4f46e5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
/* Conversation Container */
#convo-container {
display: flex;
flex-direction: column;
justify-content: center;
height: 100%;
padding: 0.5rem 1rem;
gap: 0.4rem;
overflow-y: auto;
}
.chat-bubble {
max-width: 80%;
padding: 0.6rem 1.2rem;
border-radius: 1.5rem;
transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
opacity: 1;
transform: scale(1);
font-size: 1.5rem; /* Increased 25% from 1.2rem */
line-height: 1.3;
border-width: 3px;
}
/* Active highlight */
.chat-bubble.active {
transform: scale(1.06);
font-weight: 800;
box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
z-index: 10;
font-size: 1.8rem; /* Increased 25% from 1.35rem */
}
.chat-left { align-self: flex-start; border-bottom-left-radius: 0.2rem; }
.chat-right { align-self: flex-end; border-bottom-right-radius: 0.2rem; text-align: right; }
/* Font Color Themes */
.theme-blue { background-color: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
.theme-black { background-color: #f8fafc; color: #000000; border-color: #e2e8f0; }
.theme-purple { background-color: #faf5ff; color: #6b21a8; border-color: #e9d5ff; }
.theme-emerald { background-color: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
.speaker-name { font-size: 0.9rem; font-weight: 900; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.05em; }
@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.chat-bubble { animation: slideIn 0.4s ease forwards; }
::-webkit-scrollbar { display: none; }
/* Emoji wrapper - visible but ignored by TTS */
.emoji-wrapper { display: inline-block; }
/* Header Reduction - 50% smaller */
header { padding: 0.5rem 1rem; }
.header-btn { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
/* Review Modal */
#review-modal {
display: none;
position: fixed;
top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.5);
z-index: 50;
align-items: center;
justify-content: center;
}
#review-modal.active { display: flex; }
.review-content {
background: white;
padding: 2rem;
border-radius: 2rem;
max-width: 90%;
max-height: 80vh;
overflow-y: auto;
border: 4px solid #indigo;
}
</style>
</head>
<body>
<!-- Main Menu -->
<div id="main-menu" class="screen active p-6 overflow-y-auto">
<div class="max-w-6xl mx-auto w-full">
<h1 class="text-5xl font-black text-center text-indigo-950 mb-4">English Dialogue Practice</h1>
<p class="text-center text-slate-600 mb-10 text-xl font-semibold italic text-balance">Improve your speaking and listening skills with natural conversations.</p>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
<div class="p-6 bg-blue-50 rounded-3xl border-2 border-blue-200">
<h3 class="text-blue-700 font-black text-lg uppercase mb-2">Vocabulary üçé</h3>
<p class="text-slate-800 text-xl font-bold">Learn new words in context</p>
</div>
<div class="p-6 bg-purple-50 rounded-3xl border-2 border-purple-200">
<h3 class="text-purple-700 font-black text-lg uppercase mb-2">Grammar ‚úèÔ∏è</h3>
<p class="text-slate-800 text-xl font-bold">Practice correct sentence structure</p>
</div>
<div class="p-6 bg-emerald-50 rounded-3xl border-2 border-emerald-200">
<h3 class="text-emerald-700 font-black text-lg uppercase mb-2">Skills üí°</h3>
<p class="text-slate-800 text-xl font-bold">Build real conversation abilities</p>
</div>
</div>
<div id="unit-grid" class="grid grid-cols-5 gap-4 pb-12"></div>
</div>
</div>
<!-- Objective Screen -->
<div id="objective-screen" class="screen p-4 items-center justify-center bg-slate-100">
<div class="bg-white rounded-[3rem] shadow-2xl p-10 max-w-4xl w-full border-8 border-indigo-200">
<h2 id="obj-unit-title" class="text-4xl font-black text-indigo-950 mb-8 border-b-4 border-indigo-100 pb-4 text-center"></h2>
<div class="mt-10 flex justify-center gap-4 flex-wrap">
<button onclick="startConversationFlow(1)" class="bg-indigo-600 text-white font-black py-5 px-8 rounded-full shadow-2xl hover:bg-indigo-700 transform hover:scale-110 transition-all text-lg">#1 üó£Ô∏è</button>
<button onclick="startConversationFlow(2)" class="bg-purple-600 text-white font-black py-5 px-8 rounded-full shadow-2xl hover:bg-purple-700 transform hover:scale-110 transition-all text-lg">#2 üó£Ô∏è</button>
<button onclick="startConversationFlow(3)" class="bg-emerald-600 text-white font-black py-5 px-8 rounded-full shadow-2xl hover:bg-emerald-700 transform hover:scale-110 transition-all text-lg">#3 üó£Ô∏è</button>
<button onclick="startConversationFlow(4)" class="bg-pink-600 text-white font-black py-5 px-8 rounded-full shadow-2xl hover:bg-pink-700 transform hover:scale-110 transition-all text-lg">#4 üó£Ô∏è</button>
<button onclick="startConversationFlow(5)" class="bg-orange-600 text-white font-black py-5 px-8 rounded-full shadow-2xl hover:bg-orange-700 transform hover:scale-110 transition-all text-lg">#5 üó£Ô∏è</button>
</div>
</div>
</div>
<!-- Conversation Screen -->
<div id="conversation-screen" class="screen bg-white">
<header class="border-b-2 flex justify-between items-center bg-slate-50 gap-2">
<button onclick="goToMenu()" class="header-btn bg-white border-2 border-slate-200 rounded-xl font-black text-slate-700 hover:bg-slate-100">üè†</button>
<button onclick="prevConversation()" class="header-btn bg-white border-2 border-slate-200 rounded-xl font-black text-slate-700 hover:bg-slate-100">‚¨Ö</button>
<h2 id="convo-unit-header" class="text-xl font-black text-indigo-900 flex-grow text-center"></h2>
<button onclick="nextConversation()" class="header-btn bg-white border-2 border-slate-200 rounded-xl font-black text-slate-700 hover:bg-slate-100">‚û°</button>
<button onclick="toggleReview()" class="header-btn bg-indigo-600 border-2 border-indigo-600 rounded-xl font-black text-white hover:bg-indigo-700">üìù</button>
</header>
<div id="convo-container" class="flex-grow"></div>
</div>
<!-- Review Modal -->
<div id="review-modal" onclick="if(event.target === this) toggleReview()">
<div class="review-content">
<h2 id="review-title" class="text-3xl font-black text-indigo-950 mb-4"></h2>
<div class="mb-6">
<h3 class="text-xl font-bold text-indigo-700 mb-2">üîë Keywords</h3>
<p id="review-keywords" class="text-lg text-slate-700"></p>
</div>
<div class="mb-6">
<h3 class="text-xl font-bold text-indigo-700 mb-2">‚úèÔ∏è Grammar Focus</h3>
<p id="review-grammar" class="text-lg text-slate-700"></p>
</div>
<button onclick="toggleReview()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-indigo-700">CLOSE</button>
</div>
</div>

<script>
const lessons = {
"Family": {
title: "Family üë®‚Äçüë©‚Äçüëß‚Äçüë¶", emoji: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
review: { keywords: "sister, brother, cousin, aunt, uncle, grandparents, birthday, older, younger", grammar: "Possessive 's, Comparative adjectives (older/younger), Present Simple" },
conversations: [
[
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Look at this old photo, Amy. It was sunny that day. The children were happy. üì∏" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "Who is that? Is that your cousin? üë§" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Yes! I have a sister, Holly, and two cousins. That is my aunt and my uncle. üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "Your brother is taller than you in this photo. And the red car is bigger! üöó" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Yes, but the blue car is slower. How old are you in this picture? ü§î" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "I'm seven. My birthday is in March. When is your birthday? üìÖ" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "My birthday is in August. My grandpa is ninety, and my grandma is seventy. üë¥üëµ" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "Wow! They are very old. Do they live with you? üè†" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "No, they live nearby. We visit them every Sunday. üöó" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "That is nice. Family is very important. ‚ù§Ô∏è" }
],
[
{ name: "Dad", gender: "m", voice: "william", theme: "theme-emerald", side: "left", text: "Max, who are those people in your family photo? üì∑" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "This is my mom and my dad. My dad is older than my mom. üë®‚Äçüë©" },
{ name: "Dad", gender: "m", voice: "william", theme: "theme-emerald", side: "left", text: "And who are those two children? üëßüë¶" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "This is my sister Holly, and this is me. I am smaller than Holly. üòä" },
{ name: "Dad", gender: "m", voice: "william", theme: "theme-emerald", side: "left", text: "I have a big family too. I have two brothers and one sister. üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "How old are your brothers? üéÇ" },
{ name: "Dad", gender: "m", voice: "william", theme: "theme-emerald", side: "left", text: "Tommy is eight. He is older than me. Ben is six. He is younger. üë¶" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Do you play with them often? ‚öΩ" },
{ name: "Dad", gender: "m", voice: "william", theme: "theme-emerald", side: "left", text: "Yes, we play soccer every weekend. ü•Ö" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "I want to play soccer with them too! üèÉ" }
],
[
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-blue", side: "left", text: "Do you have any cousins, Leo? üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-black", side: "right", text: "Yes! I have three cousins. Two live in Canada and one in Mexico. üåé" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-blue", side: "left", text: "Do you see them often? üëÄ" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-black", side: "right", text: "Not often. We meet during summer vacation. It's always fun! ‚òÄÔ∏è" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-blue", side: "left", text: "My cousins live nearby. We play together every weekend. ‚öΩ" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-black", side: "right", text: "That's nice! Family is very important. ‚ù§Ô∏è" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-blue", side: "left", text: "Do you send them messages? üì±" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-black", side: "right", text: "Yes, we video call on Sundays. üìπ" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-blue", side: "left", text: "Technology helps us stay close. üåê" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-black", side: "right", text: "I agree. I love my big family. üë®‚Äçüë©‚Äçüëß‚Äçüë¶" }
],
[
{ name: "Teacher", gender: "f", voice: "emma", theme: "theme-emerald", side: "left", text: "Kids, come look at this family tree! üå≥" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-purple", side: "right", text: "Wow! How many people are in our family? üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
{ name: "Teacher", gender: "f", voice: "emma", theme: "theme-emerald", side: "left", text: "There are twenty people! Your grandma and grandpa had five children. üë¥üëµ" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-purple", side: "right", text: "That's a lot! Who is the oldest? ü§î" },
{ name: "Teacher", gender: "f", voice: "emma", theme: "theme-emerald", side: "left", text: "Your Uncle John is the oldest. He is sixty-five years old. üë®" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-purple", side: "right", text: "And who is the youngest? üë∂" },
{ name: "Teacher", gender: "f", voice: "emma", theme: "theme-emerald", side: "left", text: "Your cousin Lily! She is only two years old. üéÇ" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-purple", side: "right", text: "She is very small! üìè" },
{ name: "Teacher", gender: "f", voice: "emma", theme: "theme-emerald", side: "left", text: "Yes, but she will grow fast. üå±" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-purple", side: "right", text: "I will teach her to play games! üéÆ" }
],
[
{ name: "Holly", gender: "f", voice: "ava", theme: "theme-purple", side: "left", text: "Max, let's draw our family portrait! üé®" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Good idea! Who should we draw first? üñçÔ∏è" },
{ name: "Holly", gender: "f", voice: "ava", theme: "theme-purple", side: "left", text: "Let's draw Mom and Dad in the middle. üë®‚Äçüë©" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Okay. I will draw Grandma and Grandpa next. üë¥üëµ" },
{ name: "Holly", gender: "f", voice: "ava", theme: "theme-purple", side: "left", text: "Don't forget our cousins! üëßüë¶" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Right! They are part of the family too. ‚ù§Ô∏è" },
{ name: "Holly", gender: "f", voice: "ava", theme: "theme-purple", side: "left", text: "This picture is very big! üñºÔ∏è" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Because we have a big family! üòä" },
{ name: "Holly", gender: "f", voice: "ava", theme: "theme-purple", side: "left", text: "Let's hang it on the wall. üß±" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Yes! Everyone will see it. üëÄ" }
]
]
},
"Weekend": {
title: "Weekend üö≤", emoji: "üö≤",
review: { keywords: "weekend, skateboard, gymnastics, fishing, cinema, swimming, park, vacation", grammar: "Like + ing, Present Continuous for plans, Do/Does questions" },
conversations: [
[
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "What do you like doing on the weekend, Max? ü§î" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "I like reading comics and I love to skateboard. üõπüìñ" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "I like doing gymnastics and playing volleyball. ü§∏üèê" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Does your brother like fishing? üé£" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "Yes, he does. He likes fishing and taking photos. üì∏" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Do you like playing the guitar or piano? üé∏üéπ" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "Yes, I do! I love shopping too! üõçÔ∏è" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Can we go shopping this weekend? üõí" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-black", side: "left", text: "Sure! We need new shoes. üëü" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Great! I want blue ones. üíô" }
],
[
{ name: "Dad", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "Hi Amy! What do you enjoy doing on weekends? üòä" },
{ name: "Amy", gender: "f", voice: "ava", theme: "theme-purple", side: "right", text: "I like playing basketball and listening to music. üèÄüéµ" },
{ name: "Dad", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "I like riding my bike and playing video games. üö≤üéÆ" },
{ name: "Amy", gender: "f", voice: "ava", theme: "theme-purple", side: "right", text: "Do you like photography? üì∑" },
{ name: "Dad", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "I don't mind cooking, but I prefer eating out with family. üçΩÔ∏è" },
{ name: "Amy", gender: "f", voice: "ava", theme: "theme-purple", side: "right", text: "I like to visit my grandparents on weekends too. üë¥üëµ" },
{ name: "Dad", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "That is very kind of you. ‚ù§Ô∏è" },
{ name: "Amy", gender: "f", voice: "ava", theme: "theme-purple", side: "right", text: "They make delicious cookies. üç™" },
{ name: "Dad", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "I love cookies! ü§§" },
{ name: "Amy", gender: "f", voice: "ava", theme: "theme-purple", side: "right", text: "You can come next time! üè†" }
],
[
{ name: "Teacher", gender: "f", voice: "ava", theme: "theme-emerald", side: "left", text: "What are your weekend plans, Max? üìÖ" },
{ name: "Max", gender: "m", voice: "william", theme: "theme-black", side: "right", text: "I'm going to visit my grandma on Saturday. üëµ" },
{ name: "Teacher", gender: "f", voice: "ava", theme: "theme-emerald", side: "left", text: "That's nice! What about Sunday? üåû" },
{ name: "Max", gender: "m", voice: "william", theme: "theme-black", side: "right", text: "I'm going to play football with my friends. ‚öΩ" },
{ name: "Teacher", gender: "f", voice: "ava", theme: "theme-emerald", side: "left", text: "I'm going to the park with my family. üå≥" },
{ name: "Max", gender: "m", voice: "william", theme: "theme-black", side: "right", text: "Have a great weekend! üòä" },
{ name: "Teacher", gender: "f", voice: "ava", theme: "theme-emerald", side: "left", text: "You too Max! üåü" },
{ name: "Max", gender: "m", voice: "william", theme: "theme-black", side: "right", text: "See you on Monday! üëã" },
{ name: "Teacher", gender: "f", voice: "ava", theme: "theme-emerald", side: "left", text: "Don't forget your homework! üìö" },
{ name: "Max", gender: "m", voice: "william", theme: "theme-black", side: "right", text: "I won't! I promise! ü§û" }
],
[
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-purple", side: "left", text: "What do you want to do this weekend, kids? ü§î" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Can we go to the cinema? üé¨" },
{ name: "Holly", gender: "f", voice: "ava", theme: "theme-emerald", side: "left", text: "I want to go swimming! üèä" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-purple", side: "right", text: "We can do both! Saturday cinema, Sunday pool. üéâ" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "left", text: "Great! What movie are we watching? üçø" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-purple", side: "right", text: "You can choose together. üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
{ name: "Holly", gender: "f", voice: "ava", theme: "theme-emerald", side: "left", text: "I want to see the cartoon! üê≠" },
{ name: "Max", gender: "m", voice: "brian", theme: "theme-blue", side: "right", text: "Okay, that sounds fun. üéà" },
{ name: "Mom", gender: "f", voice: "emma", theme: "theme-purple", side: "left", text: "I will buy the tickets online. üé´" },
{ name: "Holly", gender: "f", voice: "ava", theme: "theme-emerald", side: "right", text: "Yay! I love weekends! üéä" }
],
[
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "Are you free this Saturday, Amy? üìÖ" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "right", text: "Yes! Why do you ask? ü§î" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "Do you want to go to the park? üå≥" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "right", text: "Sure! I love walking in the park. üö∂" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "We can bring a ball. ‚öΩ" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "right", text: "Good idea! I will bring some water. üíß" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "I will bring snacks. üçé" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "right", text: "Perfect! What time? ‚è∞" },
{ name: "Leo", gender: "m", voice: "andrew", theme: "theme-blue", side: "left", text: "Let's meet at 10 AM. üïô" },
{ name: "Amy", gender: "f", voice: "emma", theme: "theme-black", side: "right", text: "See you then! üëã" }
]
]
}
};

const synth = window.speechSynthesis;
let williamVoice, andrewVoice, brianVoice, emmaVoice, avaVoice;
let currentLessonData = null;
let convoIndex = 0;
let isTtsActive = false;
let currentConvoType = 1;
let currentTopicKey = null;

// Emoji regex pattern
const emojiRegex = /[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F100}-\u{1F1FF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{1F700}-\u{1F77F}]|[\u{1F780}-\u{1F7FF}]|[\u{1F800}-\u{1F8FF}]|[\u{1F900}-\u{1F9FF}]|[\u{1FA00}-\u{1FA6F}]|[\u{1FA70}-\u{1FAFF}]|[\u{2300}-\u{23FF}]|[\u{25A0}-\u{25FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{2900}-\u{297F}]|[\u{2B00}-\u{2BFF}]|[\u{3030}]|[\u{303D}]|[\u{3297}]|[\u{3299}]/gu;

function wrapEmojis(text) {
return text.replace(emojiRegex, (emoji) => `<span class="emoji-wrapper">${emoji}</span>`);
}

function stripEmojis(text) {
return text.replace(emojiRegex, '').trim();
}

function initVoices() {
try {
const voices = synth.getVoices();
williamVoice = voices.find(v => v.name.includes("William")) || voices.find(v => v.name.includes("Male")) || voices[0];
andrewVoice = voices.find(v => v.name.includes("Andrew")) || voices.find(v => v.name.includes("Male")) || voices[0];
brianVoice = voices.find(v => v.name.includes("Brian")) || voices.find(v => v.name.includes("Male")) || voices[1] || voices[0];
emmaVoice = voices.find(v => v.name.includes("Emma")) || voices.find(v => v.name.includes("Female")) || voices[0];
avaVoice = voices.find(v => v.name.includes("Ava")) || voices.find(v => v.name.includes("Female")) || voices[1] || voices[0];
console.log('Voices initialized:', { williamVoice, andrewVoice, brianVoice, emmaVoice, avaVoice });
} catch(e) {
console.error('Voice init error:', e);
}
}

if (synth.onvoiceschanged !== undefined) {
synth.onvoiceschanged = initVoices;
}

// Initialize voices immediately as well
initVoices();

function speak(text, voice, onEnd) {
try {
if (synth.speaking) synth.cancel();
const utter = new SpeechSynthesisUtterance(text);
utter.voice = voice;
utter.rate = 1.0; // 100% speed (was 0.85)
utter.onend = onEnd;
synth.speak(utter);
} catch(e) {
console.error('Speak error:', e);
if (onEnd) onEnd();
}
}

function showScreen(id) {
document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
const screen = document.getElementById(id);
if (screen) {
screen.classList.add('active');
}
}

function goToMenu() {
try {
synth.cancel();
} catch(e) {}
isTtsActive = false;
showScreen('main-menu');
}

function selectUnit(unitKey) {
try {
currentLessonData = lessons[unitKey];
currentTopicKey = unitKey;
if(!currentLessonData) {
console.error('Lesson not found:', unitKey);
return;
}
document.getElementById('obj-unit-title').textContent = `${unitKey}: ${currentLessonData.title}`;
showScreen('objective-screen');
} catch(e) {
console.error('Select unit error:', e);
}
}

function startConversationFlow(convoType) {
try {
currentConvoType = convoType;
synth.cancel();
showScreen('conversation-screen');
document.getElementById('convo-unit-header').textContent = currentLessonData.title + ` (#${convoType})`;
const container = document.getElementById('convo-container');
container.innerHTML = '';
convoIndex = 0;
isTtsActive = true;
nextTurn();
} catch(e) {
console.error('Start conversation error:', e);
}
}

function nextTurn() {
if (!isTtsActive) return;
try {
if (!currentLessonData.conversations[currentConvoType - 1]) {
console.error('Conversation not found:', currentConvoType);
return;
}
let conversation = currentLessonData.conversations[currentConvoType - 1];
if (convoIndex >= conversation.length) return;
const turn = conversation[convoIndex];
const container = document.getElementById('convo-container');
const bubble = document.createElement('div');
const sideClass = turn.side === 'left' ? 'chat-left' : 'chat-right';
bubble.className = `chat-bubble ${sideClass} ${turn.theme} active fade-in`;
bubble.innerHTML = `<div class="speaker-name">${turn.name}</div>${wrapEmojis(turn.text)}`;
container.appendChild(bubble);
container.scrollTop = container.scrollHeight;
const allBubbles = container.querySelectorAll('.chat-bubble');
if (allBubbles.length > 1) {
allBubbles[allBubbles.length - 2].classList.remove('active');
}
let voiceToUse;
if (turn.voice === 'william') voiceToUse = williamVoice;
else if (turn.voice === 'andrew') voiceToUse = andrewVoice;
else if (turn.voice === 'brian') voiceToUse = brianVoice;
else if (turn.voice === 'emma') voiceToUse = emmaVoice;
else if (turn.voice === 'ava') voiceToUse = avaVoice;
else voiceToUse = turn.gender === 'm' ? andrewVoice : emmaVoice;
const cleanText = stripEmojis(turn.text);
speak(cleanText, voiceToUse, () => {
convoIndex++;
if (convoIndex < conversation.length) {
setTimeout(nextTurn, 500);
}
});
} catch(e) {
console.error('Next turn error:', e);
}
}

function repeatConversation() {
startConversationFlow(currentConvoType);
}

function nextConversation() {
if (currentConvoType < 5) {
startConversationFlow(currentConvoType + 1);
}
}

function prevConversation() {
if (currentConvoType > 1) {
startConversationFlow(currentConvoType - 1);
}
}

function toggleReview() {
const modal = document.getElementById('review-modal');
if (modal.classList.contains('active')) {
modal.classList.remove('active');
} else {
if (currentLessonData && currentLessonData.review) {
document.getElementById('review-title').textContent = currentLessonData.title;
document.getElementById('review-keywords').textContent = currentLessonData.review.keywords;
document.getElementById('review-grammar').textContent = currentLessonData.review.grammar;
modal.classList.add('active');
}
}
}

function init() {
try {
const grid = document.getElementById('unit-grid');
if (!grid) {
console.error('Unit grid not found!');
return;
}
const topics = Object.keys(lessons);
topics.forEach(key => {
const btn = document.createElement('button');
btn.className = 'unit-btn p-4 rounded-2xl shadow-lg text-center flex flex-col items-center justify-center';
btn.innerHTML = `<div class="text-4xl mb-1">${lessons[key].emoji}</div><div class="font-black text-indigo-900 text-sm">${key}</div>`;
btn.onclick = () => selectUnit(key);
grid.appendChild(btn);
});
console.log('Menu initialized with', topics.length, 'topics');
} catch(e) {
console.error('Init error:', e);
}
}

// Run init when DOM is ready
if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', init);
} else {
init();
}

// Also run on window load for voices
window.onload = function() {
init();
initVoices();
};
</script>
</body>
</html>
