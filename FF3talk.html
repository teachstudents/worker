<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESL Conversation Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; overflow: hidden; background-color: #f1f5f9; }
        .screen { display: none; height: 100vh; width: 100vw; }
        .screen.active { display: flex; flex-direction: column; }
        
        /* Menu Buttons */
        .unit-btn { transition: all 0.2s ease; border: 3px solid transparent; background-color: white; }
        .unit-btn:hover { transform: translateY(-3px); border-color: #4f46e5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        /* Conversation Container */
        #convo-container { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            height: 100%; 
            padding: 0.5rem 1rem;
            gap: 0.4rem;
        }
        
        .chat-bubble { 
            max-width: 80%; 
            padding: 0.6rem 1.2rem; 
            border-radius: 1.5rem; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            opacity: 1; /* Removed transparency/white cover - fully visible now */
            transform: scale(1);
            font-size: 1.2rem; 
            line-height: 1.3;
            border-width: 3px;
        }

        /* Active highlight focuses on scale and bolding instead of opacity */
        .chat-bubble.active { 
            transform: scale(1.06); 
            font-weight: 800; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            z-index: 10;
            font-size: 1.35rem; 
        }

        .chat-left { align-self: flex-start; border-bottom-left-radius: 0.2rem; }
        .chat-right { align-self: flex-end; border-bottom-right-radius: 0.2rem; text-align: right; }

        /* Font Color Themes */
        .theme-blue { background-color: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
        .theme-black { background-color: #f8fafc; color: #000000; border-color: #e2e8f0; } /* Changed from red to high-contrast black */
        .theme-purple { background-color: #faf5ff; color: #6b21a8; border-color: #e9d5ff; }
        .theme-emerald { background-color: #ecfdf5; color: #065f46; border-color: #a7f3d0; }

        .speaker-name { font-size: 0.8rem; font-weight: 900; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.05em; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-bubble { animation: slideIn 0.4s ease forwards; }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- Main Menu -->
    <div id="main-menu" class="screen active p-6 overflow-y-auto">
        <div class="max-w-6xl mx-auto w-full">
            <h1 class="text-5xl font-black text-center text-indigo-950 mb-4">English Dialogue Practice</h1>
            <p class="text-center text-slate-600 mb-10 text-xl font-semibold italic text-balance">Improve your speaking and listening skills with natural conversations.</p>
            <div id="unit-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 pb-12"></div>
        </div>
    </div>

    <!-- Objective Screen -->
    <div id="objective-screen" class="screen p-4 items-center justify-center bg-slate-100">
        <div class="bg-white rounded-[3rem] shadow-2xl p-10 max-w-4xl w-full border-8 border-indigo-200">
            <h2 id="obj-unit-title" class="text-4xl font-black text-indigo-950 mb-8 border-b-4 border-indigo-100 pb-4 text-center"></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-6 bg-blue-50 rounded-3xl border-2 border-blue-200">
                    <h3 class="text-blue-700 font-black text-lg uppercase mb-2">Vocabulary üçé</h3>
                    <p id="obj-vocab" class="text-slate-800 text-xl font-bold leading-snug"></p>
                </div>
                <div class="p-6 bg-purple-50 rounded-3xl border-2 border-purple-200">
                    <h3 class="text-purple-700 font-black text-lg uppercase mb-2">Grammar ‚úèÔ∏è</h3>
                    <p id="obj-grammar" class="text-slate-800 text-xl font-bold leading-snug"></p>
                </div>
                <div class="p-6 bg-emerald-50 rounded-3xl border-2 border-emerald-200">
                    <h3 class="text-emerald-700 font-black text-lg uppercase mb-2">Skills üí°</h3>
                    <p id="obj-skills" class="text-slate-800 text-xl font-bold leading-snug"></p>
                </div>
            </div>

            <div class="mt-10 flex justify-center">
                <button onclick="startConversationFlow()" class="bg-indigo-600 text-white font-black py-5 px-16 rounded-full shadow-2xl hover:bg-indigo-700 transform hover:scale-110 transition-all text-2xl">
                    LET'S TALK! üó£Ô∏è
                </button>
            </div>
        </div>
    </div>

    <!-- Conversation Screen -->
    <div id="conversation-screen" class="screen bg-white">
        <header class="p-4 border-b-2 flex justify-between items-center bg-slate-50">
            <button onclick="goToMenu()" class="bg-white border-2 border-slate-200 px-6 py-2 rounded-2xl font-black text-slate-700 flex items-center gap-2 hover:bg-slate-100">
                ‚¨Ö BACK
            </button>
            <h2 id="convo-unit-header" class="text-2xl font-black text-indigo-900"></h2>
            <button id="repeat-btn" onclick="repeatConversation()" class="bg-indigo-600 text-white font-black py-2 px-6 rounded-2xl flex items-center gap-2 hover:bg-indigo-700 shadow-lg">
                üîÑ REPEAT
            </button>
        </header>
        <div id="convo-container" class="flex-grow"></div>
    </div>

    <script>
        const lessons = {
            "Starter": { 
                title: "My Family", emoji: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", 
                vocab: "Mom üë©, Dad üë®, Grandma üëµ, Grandpa üë¥, Sister üëß, Brother üë¶, Aunt üë©‚Äçü¶±, Uncle üë®‚Äçü¶±, Cousin üë¶üëß, Numbers üî¢, Months üìÖ", 
                grammar: "Simple present (be/have), Simple past (be), Comparatives", 
                skills: "Identifying people, asking birthdays", 
                conversation: [
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Look at this old photo, Amy. It was sunny that day. The children were happy." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Who is that? Is that your cousin?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Yes! I have a sister, Holly, and two cousins. That is my aunt and my uncle. And look, there is my mom, my dad, my grandma, and my grandpa." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Your brother is taller than you in this photo. And the red car is bigger than the blue car!" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Yes, but the blue car is slower. How old are you in this picture?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "I'm seven. My birthday is in March. When is your birthday?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "My birthday is in August. My grandpa is old now; he is ninety, and my grandma is seventy." }
                ]
            },
            "Unit 1": { 
                title: "They're from Australia!", emoji: "üåç", 
                vocab: "Korea üá∞üá∑, Vietnam üáªüá≥, Mexico üá≤üáΩ, Spain üá™üá∏, Thailand üáπüá≠, Australia üá¶üá∫, U.S.A. üá∫üá∏, Brazil üáßüá∑, Seasons üå∏‚òÄÔ∏èüçÇ‚ùÑÔ∏è", 
                grammar: "Simple present questions (Where are you from?)", 
                skills: "Asking age and country, capitalizing proper nouns", 
                conversation: [
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Hi, Emma! I just made new pen pals online. This boy is Carlos." },
                    { name: "Emma", gender: "f1", theme: "theme-purple", text: "Where is he from?" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "He's from Brazil. And this girl is Ji-Young. She's from South Korea. Where are you from, Emma?" },
                    { name: "Emma", gender: "f1", theme: "theme-purple", text: "I'm from the U.S.A. My other friends are from Mexico, Spain, and Thailand. Where are your cousins from?" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "They're from Australia!" },
                    { name: "Emma", gender: "f1", theme: "theme-purple", text: "What is their favorite season?" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Their favorite season is summer because they love playing in the garden. I like spring and fall. What about you?" },
                    { name: "Emma", gender: "f1", theme: "theme-purple", text: "I like winter!" }
                ]
            },
            "Unit 2": { 
                title: "My Weekend", emoji: "üö≤", 
                vocab: "Comics üìñ, Skateboard üõπ, Gymnastics ü§∏, Chess ‚ôüÔ∏è, Fish üé£, Basketball üèÄ, Photos üì∏, Guitar üé∏, Piano üéπ", 
                grammar: "Like / don't like + verb + -ing", 
                skills: "Choosing pen pals, full and short forms of be", 
                conversation: [
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "What do you like doing on the weekend, Max?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "I like reading comics and I love to skateboard. I don't like playing chess. What about you?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "I like doing gymnastics and playing volleyball. Does your brother like fishing?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Yes, he does. He likes fishing and taking photos. But he doesn't like playing basketball." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Do you like playing the guitar or playing the piano?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "No, I don't. I prefer to paint, cook, and visit family. Do you like shopping?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Yes, I do! I love shopping." }
                ]
            },
            "Unit 3": { 
                title: "My Things", emoji: "üéÆ", 
                vocab: "Computer üíª, TV üì∫, DVD üìÄ, CD üíø, MP3 üéµ, Camera üì∑, Stickers ‚ú®, Posters üñºÔ∏è, Pins üìç, Shells üêö", 
                grammar: "Possessive adjectives (your/our/their), Can for permission", 
                skills: "Talking about collections, punctuation marks", 
                conversation: [
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "Max, can I use your computer, please? I need it for a school project." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "No, you can't. I'm using it. But you can use our Dad's new camera." },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "Okay. Can you turn on the TV, please? I want to watch a show." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Sure. Can you turn off the CD player and the MP3 player first? It's too loud." },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "Done. Look at their DVD player, it's broken. By the way, do you want to see my collections?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Yes! Are these your stickers and posters?" },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "Yes, they are. I also collect postcards, comics, pins, and shells from the beach!" }
                ]
            },
            "Unit 4": { 
                title: "At the Beach!", emoji: "üèñÔ∏è", 
                vocab: "Swim üèä, Sail ‚õµ, Dive ü§ø, Surf üèÑ, Kayak üõ∂, Windsurf üå¨Ô∏èüèÑ, Snorkel ü§ø, Clean ‚ú®, Safe ‚úÖ", 
                grammar: "Present continuous affirmative and negative", 
                skills: "Spelling rules for -ing, describing activities", 
                conversation: [
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Look at the ocean, it's so beautiful and clean! It isn't polluted or ugly at all." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "It is very safe here, not dangerous. Look at Mom and Dad. They are sailing a boat." },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "I'm swimming! What are you doing?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "I'm not swimming. I'm surfing and kayaking!" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Is Max snorkeling?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "No, he isn't snorkeling. He is diving under the water. We're having fun at the beach!" }
                ]
            },
            "Unit 5": { 
                title: "Naughty Monkey!", emoji: "üêí", 
                vocab: "Tiger üêÖ, Monkey üêí, Lion ü¶Å, Parrot ü¶ú, Penguin üêß, Zebra ü¶ì, Angry üò†, Scared üò®, Kind ü§ó", 
                grammar: "Present continuous questions and answers", 
                skills: "Using speech marks, writing animal fact files", 
                conversation: [
                    { name: "Max", gender: "m", theme: "theme-blue", text: "We are at the zoo! Are the monkeys eating their bananas?" },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "Yes, they are. Look, that monkey is taking my sandwich! It is a naughty and funny monkey." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Oh no, are you angry?" },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "No, I'm not angry. But look at the tiger. Is the tiger sleeping?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "No, it isn't. It's watching the monkeys. The monkeys are scared!" },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "Are the penguins swimming?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Yes, they are. And the lions are running. The zookeeper is very kind to the animals!" }
                ]
            },
            "Unit 6": { 
                title: "Jim's Day", emoji: "ü•û", 
                vocab: "Shower üöø, Brush teeth ü¶∑, Get dressed üëï, Breakfast ü•û, Brush hair üë©‚Äçü¶∞, Catch bus üöå, Walk üö∂", 
                grammar: "Simple present affirmative, negative, and questions", 
                skills: "Describing daily routines, proper nouns", 
                conversation: [
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "What time do you get up every day, Leo?" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "I get up early at seven o'clock. First, I have a shower and brush my teeth. Then, I get dressed and brush my hair." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Do you have breakfast with your family?" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Yes, I do. Next, I eat cereal. Finally, I catch the bus. I don't walk to school." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "What about our cousin Jim in Australia? Does he live in a big house?" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Yes, he does. He is a jackaroo. He doesn't catch a bus. He rides a horse on the weekend!" }
                ]
            },
            "Unit 7": { 
                title: "Places to Go!", emoji: "üçø", 
                vocab: "Caf√© ‚òï, Library üìö, Museum üèõÔ∏è, Playground üõù, Mall üõçÔ∏è, Pool üèä, Movie theater üé¨, Actor üßë‚Äçüé§, Singer üé∂", 
                grammar: "Adverbs of frequency (always, sometimes, never)", 
                skills: "Describing free time activities, using verbs and adjectives", 
                conversation: [
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Do you ever go to the library on the weekend?" },
                    { name: "Emma", gender: "f1", theme: "theme-purple", text: "Yes, I sometimes go to the library in the morning. But I never go to the shopping mall. It's boring!" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "I always go to the sports center and the swimming pool on Saturdays. Do you want to go to the playground?" },
                    { name: "Emma", gender: "f1", theme: "theme-purple", text: "No, Dad has tickets for the movie theater! We are going to see a new movie with a great actor." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Wow! I love the theater. Do you ever go to a concert to see a singer?" },
                    { name: "Emma", gender: "f1", theme: "theme-purple", text: "Sometimes! My birthday is in May, and we are going to a caf√© and a museum to celebrate." }
                ]
            },
            "Unit 8": { 
                title: "I'd like a Melon!", emoji: "üçà", 
                vocab: "Noodles üçú, Bread üçû, Cereal ü•£, Meat ü•©, Melon üçà, Cucumber ü•í, Onion üßÖ, Lemon üçã", 
                grammar: "Countable and uncountable nouns (a, an, some)", 
                skills: "Adjective order (size, then color), role-playing", 
                conversation: [
                    { name: "Mom", gender: "f1", theme: "theme-purple", text: "We are at the supermarket. We need a lot of things today. I'd like some meat and some bread, please." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Would you like some cereal and noodles, too?" },
                    { name: "Mom", gender: "f1", theme: "theme-purple", text: "Yes, please. And we need a big green cucumber and an onion for the salad." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "I'd like a melon! Can we get a melon and a lemon?" },
                    { name: "Mom", gender: "f1", theme: "theme-purple", text: "Yes, we can get a melon, but don't take the one at the bottom!" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Oops, sorry! Would you like a small red apple, too?" },
                    { name: "Mom", gender: "f1", theme: "theme-purple", text: "No, thanks. We have enough food." }
                ]
            },
            "Unit 9": { 
                title: "The Fastest Animal", emoji: "üêÜ", 
                vocab: "High üèîÔ∏è, Deep üåä, Long üìè, Wide ‚ÜîÔ∏è, Big üêò, Old üë¥, Mountain ‚õ∞Ô∏è, River üèûÔ∏è, Ocean üåä", 
                grammar: "Comparative and superlative adjectives", 
                skills: "Describing geographical features", 
                conversation: [
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Let's play a geography quiz! What's the highest mountain in the world?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Mount Everest is the highest mountain!" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Correct. What is the longest river? Is it the Nile?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Yes, the Nile is the longest river. And Russia is the biggest country. It is bigger than the UK." },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "What about the deepest ocean?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "The Pacific Ocean is the deepest and the widest ocean." },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Wow, you are so smart. What is the fastest animal?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "The cheetah is the fastest animal, but the mouse is the smallest!" }
                ]
            },
            "Unit 10": { 
                title: "In the Park!", emoji: "üå≥", 
                vocab: "Path üõ§Ô∏è, Grass üå±, Flowers üå∏, Bin üóëÔ∏è, Trees üå≥, Fountain ‚õ≤, Shout üó£Ô∏è, Chase üèÉ, Cross üåâ", 
                grammar: "Must / Mustn't for rules and obligations", 
                skills: "Using and / or, writing park rules", 
                conversation: [
                    { name: "Dad", gender: "m", theme: "theme-emerald", text: "Welcome to the park, kids! Remember the rules. You must walk on the path, and you mustn't walk on the grass." },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "Can we pick the flowers or climb the trees?" },
                    { name: "Dad", gender: "m", theme: "theme-emerald", text: "No, you mustn't pick the flowers or climb the trees. And you must put your litter in the garbage can." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Let's go to the playground! I want to run and chase Leo!" },
                    { name: "Dad", gender: "m", theme: "theme-emerald", text: "You can play, but you mustn't shout, and please don't fall in the fountain!" },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "I'm going to cross the bridge to meet my friends. We are going to catch a ball and laugh!" }
                ]
            },
            "Unit 11": { 
                title: "In the Museum", emoji: "üèõÔ∏è", 
                vocab: "Ferry ‚õ¥Ô∏è, Bus üöå, Helicopter üöÅ, Motorbike üèçÔ∏è, Taxi üöï, Tram üöÉ, Along ‚û°Ô∏è, Through üîÄ, Inside üì•", 
                grammar: "Simple past with be (There was / wasn't)", 
                skills: "Historical site descriptions, writing paragraphs", 
                conversation: [
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Look at this transport museum! There are so many cool vehicles inside." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Look at these old photos of our town fifty years ago. There wasn't a shopping mall, but there were shops along the street." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Were there any planes or helicopters fifty years ago?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Yes, there were some planes, but there weren't any modern motorbikes. People traveled by train and tram." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Look at this horse bus in the middle of the room! Two hundred years ago, there weren't any cars." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Wow. And to get across the river, there was a big ferry between the two towns!" }
                ]
            },
            "Unit 12": { 
                title: "A Clever Baby!", emoji: "üë∂", 
                vocab: "Old üë¥, Young üë∂, Handsome ü§µ, Pretty üë∞, Shy üôà, Friendly üòä, Cheerful üòÑ, Generous üéÅ", 
                grammar: "Simple past with be and have (was, had)", 
                skills: "True/False statements, linking ideas with and / but", 
                conversation: [
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "Look at this family photo album! Who is this young boy?" },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "That is Grandpa when he was young! He had black hair then. Now he has white hair and he is old." },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "He was very handsome. And look at Grandma, she was very pretty and cheerful. She is still pretty, but very relaxed now." },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "Look at this photo of Max. He was a clever baby, but he was very shy and short!" },
                    { name: "Holly", gender: "f1", theme: "theme-purple", text: "I wasn't tall when I was five, but I was very friendly and generous." },
                    { name: "Leo", gender: "m", theme: "theme-blue", text: "You didn't have long hair when you were a baby, but you were never sad or worried!" }
                ]
            },
            "Unit 13": { 
                title: "Ancient Mayans", emoji: "üè∫", 
                vocab: "Start ‚ñ∂Ô∏è, Finish üèÅ, Want üôè, Live üè†, Heavy üèãÔ∏è, Light ü™∂, Hard üß±, Soft üß∏, Easy ‚úÖ, Difficult ‚ùå", 
                grammar: "Simple past with regular verbs (lived, cooked)", 
                skills: "Topic headings, writing history", 
                conversation: [
                    { name: "Max", gender: "m", theme: "theme-blue", text: "I'm doing a school project on the Ancient Mayans. They lived 5,000 years ago!" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Wow! Did they live in apartments?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "No, they didn't live in apartments. They lived in traditional houses. And they didn't cook pizza; they cooked meat and vegetables." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Did they use computers?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "No, they didn't use computers. It was very difficult. They used secret messages and a special alphabet." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "They didn't have heavy beds either. They loved to use hammocks because they were light and soft!" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "I want to finish this project. Let's start writing, and then we can laugh and play!" }
                ]
            },
            "Unit 14": { 
                title: "A Good Day?", emoji: "üéí", 
                vocab: "Paintbrush üñåÔ∏è, Apron üéΩ, Paint üé®, Lunch box üç±, Calculator üßÆ, Backpack üéí, Dictionary üìñ, Tent ‚õ∫, Sleeping bag üõå", 
                grammar: "Simple past questions (Did you...?)", 
                skills: "Time words sequence (first, then, next, finally)", 
                conversation: [
                    { name: "Mom", gender: "f1", theme: "theme-purple", text: "Did you have a good day at school today, Amy?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "No, I didn't! First, I forgot my backpack. Then, in math class, I didn't have my calculator." },
                    { name: "Mom", gender: "f1", theme: "theme-purple", text: "Oh no! Did you use your paintbrush and paint in art class?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Yes, I did. But I didn't wear an apron, so my clothes are dirty! Next, I couldn't find my dictionary for English class." },
                    { name: "Mom", gender: "f1", theme: "theme-purple", text: "What did Leo do today? Did he go on his school camping trip?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Yes, he did! Finally, some good news. They slept in a tent in sleeping bags." },
                    { name: "Mom", gender: "f1", theme: "theme-purple", text: "Where did they cook their food?" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "They used matches to start a fire, and they cooked in a frying pan! At night, they used a flashlight because it was dark." }
                ]
            },
            "Unit 15": { 
                title: "Our Vacation!", emoji: "‚úàÔ∏è", 
                vocab: "Suitcase üß≥, Sunscreen üß¥, Towel üßñ, Soap üßº, Shampoo üß¥, Hairbrush ü™Æ, Toothbrush ü™•, Toothpaste üß¥", 
                grammar: "Be going to + verb for future plans", 
                skills: "Opening/Closing remarks in emails", 
                conversation: [
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Are you going to pack your suitcase tonight? We leave for vacation tomorrow!" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Yes, I am. I'm going to pack my towel, my toothbrush, and my toothpaste. What are you going to take?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "I'm going to take soap, shampoo, and my hairbrush. Mom says we must pack sunscreen because we are going to swim!" },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "Are you going to play basketball this afternoon?" },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "No, I'm not. I'm going to help Dad with the bags later." },
                    { name: "Amy", gender: "f2", theme: "theme-black", text: "We are going to have a great time next week! I'm going to write an email to my friends back home soon." },
                    { name: "Max", gender: "m", theme: "theme-blue", text: "Don't forget to start with \"Dear\" and end with \"Write soon\"!" }
                ]
            }
        };

        const synth = window.speechSynthesis;
        let brianVoice, andrewVoice, emmaVoice, avaVoice;
        let currentLessonData = null;
        let convoIndex = 0;
        let isTtsActive = false;

        function initVoices() {
            const voices = synth.getVoices();
            // Priorities: Microsoft Online Natural
            brianVoice = voices.find(v => v.name.includes("Brian") && v.name.includes("Online"));
            andrewVoice = voices.find(v => v.name.includes("Andrew") && v.name.includes("Online"));
            emmaVoice = voices.find(v => v.name.includes("Emma") && v.name.includes("Online"));
            avaVoice = voices.find(v => v.name.includes("Ava") && v.name.includes("Online"));

            // Robust Fallbacks
            if (!brianVoice) brianVoice = voices.find(v => v.lang.startsWith("en-GB")) || voices[0];
            if (!andrewVoice) andrewVoice = voices.find(v => v.name.includes("Male") && v.lang.startsWith("en")) || voices[0];
            if (!emmaVoice) emmaVoice = voices.find(v => v.name.includes("Female") && v.lang.startsWith("en")) || voices[0];
            if (!avaVoice) avaVoice = voices.find(v => v.name.includes("Google US English")) || voices[1] || voices[0];
        }

        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = initVoices;

        function speak(text, voice, onEnd) {
            if (synth.speaking) synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.voice = voice;
            utterate = 0.85; // Mandatory 85% slow speed
            utter.onend = onEnd;
            synth.speak(utter);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goToMenu() {
            synth.cancel();
            isTtsActive = false;
            showScreen('main-menu');
        }

        function selectUnit(unitKey) {
            currentLessonData = lessons[unitKey];
            if(!currentLessonData) return;
            document.getElementById('obj-unit-title').textContent = `${unitKey}: ${currentLessonData.title}`;
            document.getElementById('obj-vocab').textContent = currentLessonData.vocab;
            document.getElementById('obj-grammar').textContent = currentLessonData.grammar;
            document.getElementById('obj-skills').textContent = currentLessonData.skills;
            showScreen('objective-screen');
            // Remove emojis for speech processing
            const cleanVocab = currentLessonData.vocab.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, "");
            const text = `${unitKey}. ${currentLessonData.title}. Vocabulary includes: ${cleanVocab}. Grammar focus: ${currentLessonData.grammar}. Skills: ${currentLessonData.skills}.`;
            speak(text, brianVoice, null);
        }

        function startConversationFlow() {
            synth.cancel();
            showScreen('conversation-screen');
            document.getElementById('convo-unit-header').textContent = currentLessonData.title;
            const container = document.getElementById('convo-container');
            container.innerHTML = '';
            convoIndex = 0;
            isTtsActive = true;
            nextTurn();
        }

        function nextTurn() {
            if (!isTtsActive || convoIndex >= currentLessonData.conversation.length) return;

            const turn = currentLessonData.conversation[convoIndex];
            const container = document.getElementById('convo-container');
            
            const bubble = document.createElement('div');
            // Logic for left/right placement
            const isLeft = (turn.name !== "Amy" && turn.name !== "Emma" && turn.name !== "Ji-Young" && turn.name !== "Mom");
            const sideClass = isLeft ? 'chat-left' : 'chat-right';
            
            bubble.className = `chat-bubble ${sideClass} ${turn.theme} active fade-in`;
            bubble.innerHTML = `<div class="speaker-name">${turn.name}</div>${turn.text}`;
            container.appendChild(bubble);

            // Keep all text visible, but de-activate previous lines for subtle focus
            const allBubbles = container.querySelectorAll('.chat-bubble');
            if (allBubbles.length > 1) {
                allBubbles[allBubbles.length - 2].classList.remove('active');
            }

            // Voice selection logic
            let voiceToUse;
            if (turn.gender === 'm') voiceToUse = andrewVoice;
            else if (turn.gender === 'f1') voiceToUse = emmaVoice;
            else voiceToUse = avaVoice;

            speak(turn.text, voiceToUse, () => {
                convoIndex++;
                if (convoIndex < currentLessonData.conversation.length) {
                    setTimeout(nextTurn, 500);
                }
            });
        }

        function repeatConversation() {
            startConversationFlow();
        }

        function init() {
            const grid = document.getElementById('unit-grid');
            const sortedKeys = Object.keys(lessons).sort((a,b) => {
                if(a === "Starter") return -1;
                if(b === "Starter") return 1;
                return parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]);
            });
            
            sortedKeys.forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'unit-btn p-5 rounded-[2.5rem] shadow-lg text-center flex flex-col items-center justify-center';
                btn.innerHTML = `<div class="text-5xl mb-2">${lessons[key].emoji}</div><div class="font-black text-indigo-900 text-lg">${key}</div><div class="text-slate-500 font-bold text-xs uppercase tracking-tighter">${lessons[key].title}</div>`;
                btn.onclick = () => selectUnit(key);
                grid.appendChild(btn);
            });
            initVoices();
        }

        window.onload = init;
    </script>
</body>
</html>
